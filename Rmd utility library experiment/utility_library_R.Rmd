---
output:
  word_document: default
  html_document: default
  pdf_document: default
---
<!-- Include this for any .Rmd file to enable graphic positioning
This library was developed experimentally to provide a R-Studio function for placing images within R documents. It works well for html but for MS Word it relies completely upon Word's custom paragraph and character styles and requires a large library of styles to be included within the Word template used for docx generation.

This was superseded by a new lua filter that accepts the default markdown image notation, along with additional attributes, and generates html-native and Word-native code for direct inclusion in final documennts.
-->

```{r setup, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(stringr)
docformat <- knitr::opts_knit$get("rmarkdown.pandoc.to")
```

```{r, function_placeimage, echo=FALSE, raw=TRUE, title="Using function insertImage"}
page_width <- 6.5 ; #set default printed page width in inches; used when width expressed as %
pixels_per_in <- 96
cm_per_in <- 2.54
null_image <- "./images-md/1-pixel-transparent.png"

placeImage <- function(docformat, parameters) {
  params <- trimws(parameters)
  vars_processed <- FALSE # init
  var_nam <- as.character("") # Init as char string
  var_nam_len <- as.integer(0) # Init as integer
  var_names <- list() # Init lists
  var_vals <- list()
  counter <- 1
  results <- ""
  width <- ""
  err_msg <- ""
  
  while (vars_processed == FALSE){
    divider <- str_locate(params,"=")[1] # Find name/value divider?
    if (!is.na(divider)) { # Found another variable
      vars_processed <- FALSE
    } else {
      vars_processed <- TRUE # no more variables
    }
    # Get variable name
    var_nam_len <- divider - 1
    var_nam <- str_to_lower(str_trim(str_sub(params, 1, var_nam_len)))
    var_names[counter] <- var_nam
    params <- str_trim(str_sub(params, divider + 1, str_length(params)))  # Truncate used spec
    
    # Get variable value
    first_char <- substring(params, 1, 1) # If first char is quote, then value surrounded by string quotes
    var_val_end <- 2 # Init as search start
    search_area <- str_sub(params, 2, str_length(params))
    quote_length <- 0	# Default (must be 0 or 1)
    found_delim <- NA # Default is quote/s not found
    if (first_char == '"' || first_char == "'") { # Is first char a string delimiter
      found_delim <- str_locate(search_area, first_char)[1]
      if (!is.na(found_delim)) {	# If found
        var_val_end <- found_delim; # then end indicated by closing delimiter
        quote_length <- 1
      } else { # Not getting string value
        quote_length <- 0
      }
    }
    # Now search for next comma
    search_area <- str_sub(params, max(quote_length + 1, var_val_end + quote_length), str_length(params))
    next_comma <- str_locate(search_area, ",")[1] # Get num chars till end
    if (is.na(next_comma)) { # If no more, value is to end of line
      vars_processed <- TRUE	# Indicate all variables processed
      var_val_end <- str_length(params) - quote_length # Get remainder of line
    } else {
      vars_processed <- FALSE	# Indicate more variables to process
      if (quote_length == 0) {
        var_val_end <- next_comma # Point to end of value
      }
    }
    var_val <- str_sub(params, quote_length + 1, var_val_end)	# From 1st
    if (quote_length == 0) { # If not a string to be printed
      var_val <- str_to_lower(var_val)  # convert to lowercase
    }
    
    #params <- str_trim(str_sub(params, max(var_val_end + quote_length, next_comma + 2), str_length(params))); # Truncate processed params
    if (vars_processed == FALSE) {
      #params <- str_trim(str_sub(params, next_comma + quote_length + 1, str_length(params))); # Truncate processed params
      params <- str_trim(str_sub(params, var_val_end + quote_length + 2, str_length(params))); # Truncate processed params
    }
    # if (quote_length = 1) { # If this was a quoted value
    #   new_start <- var_val_end + quote_length + 1
    # } else {
    #   new_start <- var_val_end + quote_length
    # }
    #params <- str_trim(str_sub(params, max(var_val_end + quote_length, next_comma + 1), str_length(params))); # Truncate processed params
    
    var_vals[counter] <- var_val[1]
    results <- str_c(results, "\n\n", var_names[counter], " — ", var_vals[counter])
    counter <- counter + 1
  } # End while
  
  #return(results)  
  
  #sprintf("var_nam:%s; var_val:%s; var_val_end:%s; quote_length:%s; divider:%s; next_comma:%s; found_delim:%s; first_char:%s;\n\nparams:%s", var_nam, var_val, var_val_end, quote_length, divider, next_comma, found_delim, first_char, params)
  # Initialize parameters
  src <- ""
  position <- ""
  caption_html <- ""
  caption_text <- ""
  caption_position <- "above"
  caption_h_position <- "center"
  style <- ""
  caption_style <- ""
  caption_text_style <- ""
  width <- "50%"	# default
  caption_width <- "100%" # default
  caption_text_align <- "left"	# default
  
  custom_style <- "Fig-left-"  # Word style default
  custom_cap_style <- "Fig-cap-left-"  # Word caption style default
  
  # Process each processed parameter
  counter <- 1  # Reset counter
  while (counter <= length(var_names)) {
    if (var_names[counter] == "src") { # Get name of image source file
      src <- var_vals[counter]
    } else if (var_names[counter] == "width") { # Get image width
      width <- var_vals[counter] # Get width spec string as entered
      width_in <- widthToInches(width)  # Get width in inches for print media
      style <- str_c(style, "width:", width, "; ") # Add width to html style
      #caption_style <- str_c(caption_style, "width:", width, "; ")
    } else if (var_names[counter] == "position") { # Get image position
      position <- var_vals[counter]
      if (var_vals[counter] == "left") {
        custom_style <- "Fig-left-" # Get MS Word image style root
        custom_cap_style <- "Fig-cap-left-" # Get MS Word caption style root
        style <- str_c(style, "margin-left:0px; margin-right:auto; padding: 10px 15px 10px 0px; ") # Add to html style
      } else if (var_vals[counter] == "right") {
        custom_style <- "Fig-right-"
        custom_cap_style <- "Fig-cap-right-"
        style <- str_c(style, "margin-right:0px; margin-left:auto; padding: 10px 0px 15px 10px; ")
      } else if (var_vals[counter] == "float-left") {
        custom_style <- "Fig-float-left-"
        custom_cap_style <- "Fig-cap-float-left-"
        style <- str_c(style, "float:left; padding: 10px 10px 15px 0px; ")
      } else if (var_vals[counter] == "float-right") {
        custom_style <- "Fig-float-right-"
        custom_cap_style <- "Fig-cap-float-right-"
        style <- str_c(style, "float:right; padding: 10px 0px 15px 10px; ")
      } else if (var_vals[counter] == "center") {
        custom_style <- "Fig-center-"
        custom_cap_style <- "Fig-cap-center-"
        style <- str_c(style, "margin-left:auto; margin-right:auto; padding: 10px 0px 15px 0px; ")
      } else if (var_vals[counter] == "float-center") {
        custom_style <- "Fig-float-center-"
        custom_cap_style <- "Fig-cap-float-center-"
        style <- str_c(style, "margin-left:auto; margin-right:auto; padding: 10px 0px 15px 0px; ")
      } else {
        err_msg(str_c("Bad value (", var_vals[counter], ") specified for ", var_names[counter], " for figure ", src))
      }
    } else if (var_names[counter] == "caption" || var_names[counter] == "caption-above") { # Get caption position
      caption_position <- "above"
      #padding_spec <- "0 0 10px 0"
      caption_style <- str_c(caption_style, "padding: 0 0 10px 0; ")
      caption_text <- var_vals[counter]; # Get text
    } else if (var_names[counter] == "caption-below") {
      caption_position <- "below"
      caption_style <- str_c(caption_style, "padding: 10px 0 0 0; ")
      caption_text <- var_vals[counter]; # Get text
    } else if (var_names[counter] == "caption-left") {
      caption_position <- "left"
      caption_style <- str_c(caption_style, "padding: 0 10px 0 0; ")
      caption_text <- var_vals[counter] # Get text
    } else if (var_names[counter] == "caption-right") {
      caption_position <- "right"
      caption_style <- str_c(caption_style, "padding: 0 0 0 10px; ")
      caption_text <- var_vals[counter] # Get text
    } else if (var_names[counter] == "caption-width") { # Get caption width
      caption_width <- var_vals[counter]	# Get caption width
      caption_style <- str_c(caption_style, "width:", var_vals[counter], "; ")
    } else if (var_names[counter] == "caption-h-position") { # Get caption horiz position
      caption_h_position <- var_vals[counter]	# Get caption alignment
      if (var_vals[counter] == "left") {
        caption_style <- str_c(caption_style, "margin-left:0px; margin-right:auto; ")
      } else if (var_vals[counter] == "right") {
        caption_style <- str_c(caption_style, "margin-right:0px; margin-left:auto; ")
      } else if (var_vals[counter] == "center") {
        caption_style <- str_c(caption_style, "margin:auto; ")
      } else {
        err_msg(str_c("Bad value (", var_vals[counter], ") specified for ", var_names[counter], " for figure ", src))
      }
    } else if (var_names[counter] == "caption-text-align") {
      caption_align <- var_vals[counter]	# Get caption alignment
      caption_text_style <- str_c(caption_text_style, "text-align:", var_vals[counter], "; ")
    } else if (var_names[counter] == "caption-text-font") {
      caption_align <- var_vals[counter]	# Get caption font
      caption_text_style <- str_c(caption_text_style, "font-family:", var_vals[counter], "; ")
    } else if (var_names[counter] == "caption-text-size") {
      caption_align <- var_vals[counter]	# Get caption font size
      caption_text_style <- str_c(caption_text_style, "font-size:", var_vals[counter], "; ")
    } else if (var_names[counter] == "caption-text-style") {
      caption_align <- var_vals[counter]	# Get caption font style
      caption_text_style <- str_c(caption_text_style, "font-style:", var_vals[counter], "; ")
    } else {
      err_msg <- (str_c("Please correct bad description (", var_names[counter], ") specified for figure '", src, "'"))
    }
    counter <- counter + 1  # Next variable
  }
  
  
  results <- str_c("style: ", style, "\n\ncaption_style: ", caption_style, "\n\n")
  #return(results)
  
  if (docformat == "html") { # For html documents
    if (caption_position == "above" || caption_position == "below") {
      #caption_style <- str_c(caption_style, "width:", caption_width, "; padding:", padding_spec, "; ")
      #caption_style <- str_c(caption_style, "padding:", padding_spec, "; ")
      caption_html <- str_c("<div id='caption_div' style='", caption_style, "'><p style='", caption_text_style, "'>", caption_text, "</p></div>")
    }
    
    
    if (caption_position == "left" || caption_position == "right") {
      #caption_html <- str_c("<div id='caption_div' style='width:", caption_width, "'><p style='font-style:italic; text-align:", caption_align, "'>", caption_text, "</p></div>")
      caption_html <- str_c("<div id='caption_div' style='", caption_style, "'><p>", caption_text, "</p></div>")
    }
    
    if (caption_position == "above") {
      results <- str_c("<div style='", style, "'>", caption_html, "<img src='", src, "' width='100%'></div>")
    } else if (caption_position == "below") {
      results <- str_c("<div style='", style, "'><img src='", src, "' width='100%'>", caption_html, "</div>")
    } else if (caption_position == "left") {
      # code
    } else if (caption_position == "right") {
      # code
    }
    #results <- str_c("caption_position:", caption_position,"; format:", docformat)
    
  } else if (docformat == "docx") { # For Word documents
    if (caption_position == "above") {
      results <- str_c('::: {custom-style="', custom_cap_style, toCustomStyleSuf(width_in), '"}\n[', caption_text, ']{custom-style="Caption-text"}\n:::\n\n::: {custom-style="', custom_style, toCustomStyleSuf(width_in), '"}\n![](', src, '){width=', toString(width_in), 'in', '}\n:::', sep="")
    } else if (caption_position == "below"){
      results <- str_c('::: {custom-style="', custom_style, toCustomStyleSuf(width_in), '"}\n![](', src, '){width=', toString(width_in), 'in', '}\n:::\n\n::: {custom-style="', custom_cap_style, toCustomStyleSuf(width_in), '"}\n[', caption_text, ']{custom-style="Caption-text"}\n:::', sep="")
    }
    
  } else if (docformat == "pdf" || docformat == "latex") { # For pdf documents
  #} else {
    #results <- ""
    #return(results)
    results <- str_c('![', caption_text, '](', src, '){width="', width, '"}\n')
  } # End if
  
  #paste0(results)
  if (str_length(err_msg) > 0) {
    results <- str_c("[ERROR IN IMAGE PLACEMENT INFORMATION — ", err_msg, "]\n\n", results)
  }
  return (results)
}

# Conversion functions
widthToInches <- function(width) { # Convert any dimension value into inches
  width_num <- str_extract(width, "^[\\d\\.]+")	# Get number
  width_dim <- str_to_lower(str_extract(width, "[:alpha:]+\\b"))	# Get dimension
  if (is.na(width_dim)) { # Account for percent character being ignored by extraction
    width_dim <- "%"
  }
  x <- ""
  if (str_detect(width_dim, "%")) { # If expressed as percentage
    wid_in <- as.numeric(width_num)/100 * page_width
    x <- str_c(x, "percentage", "; ")
  } else if (!is.na(str_locate(width_dim, "in")[1])) { # If expressed in inches
    wid_in <- as.numeric(width_num)  # Get value in inches
    x <- str_c(x, "inches", "; ")
  } else if (!is.na(str_locate(width_dim, "px")[1])) { # If expressed in pixels
    wid_in <- as.numeric(width_num) / pixels_per_in # Get value in inches
    x <- str_c(x, "pixels", "; ")
  } else if (!is.na(str_locate(width_dim, "cm")[1])) { # If expressed in centimeters
    wid_in <- as.numeric(width_num)/cm_per_in # Get value in inches
    x <- str_c(x, "centimeters", "; ")
  } else {
    wid_in <- "Bad width specified"
    x <- str_c(x, "Error", "; ")
  }
  #return(str_c("Crumbs: ", x, "\n\nWidth:", width, "; Dim:", width_dim, "; width_num:", width_num, "; wid_in:", wid_in,"; Px-per-in:", pixels_per_in, sep=""))
  return(wid_in)
}

toCustomStyleSuf <- function(val) { # Convert num to int and remainder rounded to nearest half as string, e.g., 3.43 to "3-5"
  num <- as.numeric(str_extract(val, "^[\\d\\.]+"))	# Get number
  #num_rounded <- round(num*2)/2 # To nearest 0.5
  num_rounded <- round(num*4)/4 # To nearest 0.25
  width_left <- as.integer(num_rounded)
  width_right <- str_sub(str_extract(toString(num_rounded - width_left), "\\.[:digit:]+"), 2, )
  if (is.na(width_right)) {
    width_right <- "0"
  }
  return (str_c(toString(width_left), "-", width_right))
  #return (str_c("Derived from:", (num_rounded - width_left), "; num_rounded:", num_rounded, "; width_left:", width_left, "; String:", toString(width_left), "-", toString(width_right)))
}

```
